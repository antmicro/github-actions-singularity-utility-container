Bootstrap: docker
From: alpine:3.15.4

%environment
	export SSH_TUNNELS_DIR=/var/run/ssh_tunnels

%apprun sshtunnel
	TUNNEL_DIR="$SSH_TUNNELS_DIR/$1"
	mkdir -p $TUNNEL_DIR

	CONFIG_FILE="$TUNNEL_DIR/ssh_config"
	echo $2 | base64 -d > $CONFIG_FILE

	PRIVKEY_FILE="$TUNNEL_DIR/id_rsa"
	echo $3 | base64 -d > $PRIVKEY_FILE
	chmod 600 $PRIVKEY_FILE

	HOSTNAME=$(awk '/Host[[:blank:]][A-Za-z0-9\-_]+/ { print $2; exit 0 }' $CONFIG_FILE)

	if [ -z "$HOSTNAME" ]; then
		echo "No host declaration in SSH configuration file!"
		exit 1
	fi

	echo "Connecting to $HOSTNAME"

	ssh -F $CONFIG_FILE -i $PRIVKEY_FILE -f -N \
		-o "LogLevel=ERROR" \
		-o "ConnectTimeout=15" \
		-o "IdentitiesOnly=yes" \
		-o "PasswordAuthentication=no" \
		$HOSTNAME	

%post
	apk add --no-cache openssh
